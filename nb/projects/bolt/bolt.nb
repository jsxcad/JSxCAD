const Profile = (pitch = 1, depth = 4 / 3) =>
  Path(
    Point(0, 0),
    Point(pitch / -2, depth),
    Point(pitch / 2, depth),
    Point(0, 0)
  ).fill();

export const ScrewThread = (
  diameter,
  height,
  { pitch = 1, angle = 60 / 360, play = 0.01, lefthanded = false } = {}
) => {
  const depth = pitch / 2 / Math.tan(angle * Math.PI);
  const thread = Profile(pitch, depth)
    .y(diameter / -2 - depth / 4)
    .ry(1 / 4)
    .loft(
      seq((t) => (s) => s.rz(t).z(pitch * t * 1.001), {
        from: -1 / 2,
        by: 1 / 32,
        to: 3 / 2,
      })
    )
    .clip(Box(diameter).ex(pitch))
    .z(seq((a) => a, { from: 0, to: height, by: pitch }))
    .clip(Arc(diameter).ex(height))
    .and(Arc(diameter - depth).ex(height));
  if (lefthanded) {
    return thread.scale(1, 1, -1).z(height);
  } else {
    return thread;
  }
};

export const NutThread = (
  diameter,
  height,
  { pitch = 2, angle = 60 / 360, play = 0.1, lefthanded = false } = {}
) => {
  const screwThread = ScrewThread(diameter, pitch, {
    pitch: pitch,
    angle: angle,
    play: -1 * play,
  }).view();
  const depth = pitch / 2 / Math.tan(angle * Math.PI);
  return Arc(diameter + 2 * pitch)
    .ex(pitch)
    .cut(screwThread)
    .z(seq((a) => a, { from: 0, to: height, by: pitch }))
    .clip(Box(diameter + 2 * pitch).ex(height));
};

const nutThread = NutThread(20, 10).material('steel').stl('nut 20x10');

const screwThread = ScrewThread(20, 10, { pitch: 2 })
  .cut(
    Box(2, 10)
      .ex(10, 5)
      .rz(0, 1 / 4)
  )
  .material('steel')
  .stl('thread 20x10');

md`Left hand vs right hand.`;

Group(
  ScrewThread(5, 5, { pitch: 0.5, lefthanded: true }).x(-3),
  ScrewThread(5, 5, { pitch: 0.5, lefthanded: false }).x(3)
).view();

md`Show the fit.`;
ScrewThread(20, 10, { pitch: 2, play: 0 }).material('steel').view();

NutThread(20, 10, { pitch: 1, play: 0 }).material('steel').view();

Group(
  ScrewThread(20, 10, { pitch: 2, play: 0 }).material('steel'),
  NutThread(20, 10, { pitch: 2, play: 0 }).material('steel')
)
  .cut(Box(500, 500, 500).x(250))
  .view();

//ScrewThread(10, 5)
//  .and(NutThread(10, 5).and(Arc(15).cut(Arc(10)).ex(5)))
//  .view(1)
//  .view(2, section());
